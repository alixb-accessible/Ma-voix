<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assistant Parole</title>
    <link rel="stylesheet" href="https://alixb-accessible.github.io/faites-mieux-toolbar/faites-mieux.css">
    <script src="https://alixb-accessible.github.io/faites-mieux-toolbar/faites-mieux.js" defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg, 
                #4a4a4a 0%, #4a4a4a 14.28%,
                #22c55e 14.28%, #22c55e 28.56%,
                #3b82f6 28.56%, #3b82f6 42.84%,
                #ffffff 42.84%, #ffffff 57.12%,
                #fbbf24 57.12%, #fbbf24 71.4%,
                #dc2626 71.4%, #dc2626 85.68%,
                #4a4a4a 85.68%, #4a4a4a 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            max-width: 700px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            text-align: center;
            color: #1f2937;
            margin-bottom: 30px;
            font-size: 2em;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #374151;
            font-weight: 600;
            font-size: 1.1em;
        }

        textarea {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            border: 2px solid #d1d5db;
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.3s;
        }

        textarea:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .controls > div {
            width: 100%;
        }

        select {
            width: 100%;
            padding: 18px 50px 18px 15px;
            border: 2px solid #d1d5db;
            border-radius: 10px;
            font-size: 18px;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 24px;
            touch-action: manipulation;
        }

        select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2);
        }

        optgroup {
            font-weight: bold;
            font-size: 17px;
            color: #1f2937;
            padding: 10px 0;
            background: #f3f4f6;
        }

        option {
            padding: 12px;
            font-size: 17px;
            background: white;
            color: #1f2937;
        }

        .buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        button {
            flex: 1;
            min-width: 140px;
            padding: 18px 30px;
            font-size: 19px;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            -webkit-tap-highlight-color: rgba(0,0,0,0.1);
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
            min-height: 60px;
        }

        .btn-speak {
            background: #22c55e;
            color: white;
        }

        .btn-speak:hover {
            background: #16a34a;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(34, 197, 94, 0.4);
        }

        .btn-speak:active {
            background: #16a34a;
            transform: scale(0.98);
        }

        .btn-speak:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .btn-stop {
            background: #dc2626;
            color: white;
        }

        .btn-stop:hover {
            background: #b91c1c;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 38, 38, 0.4);
        }

        .btn-stop:active {
            background: #b91c1c;
            transform: scale(0.98);
        }

        .btn-stop:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .btn-clear {
            background: #6b7280;
            color: white;
        }

        .btn-clear:hover {
            background: #4b5563;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(107, 114, 128, 0.4);
        }

        .btn-clear:active {
            background: #4b5563;
            transform: scale(0.98);
        }

        .status {
            text-align: center;
            margin-top: 20px;
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 16px;
        }

        .status.speaking {
            background: #dcfce7;
            color: #166534;
        }

        .status.idle {
            background: #f3f4f6;
            color: #6b7280;
        }

        .collapsible-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 3px solid #e5e7eb;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            padding: 15px;
            background: #f9fafb;
            border-radius: 10px;
            transition: all 0.3s;
            user-select: none;
        }

        .section-header:hover {
            background: #f3f4f6;
        }

        .section-header h2 {
            color: #1f2937;
            font-size: 1.3em;
            margin: 0;
        }

        .section-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #6b7280;
            font-size: 0.9em;
        }

        .toggle-icon {
            width: 24px;
            height: 24px;
            transition: transform 0.3s;
        }

        .toggle-icon.collapsed {
            transform: rotate(-90deg);
        }

        .section-content {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out, margin 0.3s ease-out;
            opacity: 1;
            margin-top: 15px;
        }

        .section-content.collapsed {
            max-height: 0;
            opacity: 0;
            margin-top: 0;
        }

        .history-container {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }

        .history-item {
            background: white;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .history-item:last-child {
            margin-bottom: 0;
        }

        .history-text {
            color: #1f2937;
            margin-bottom: 8px;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .history-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .icon-btn {
            padding: 8px 12px;
            font-size: 14px;
            font-weight: 500;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            touch-action: manipulation;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .icon-btn svg {
            width: 16px;
            height: 16px;
        }

        .icon-btn-play {
            background: #22c55e;
            color: white;
        }

        .icon-btn-play:hover {
            background: #16a34a;
        }

        .icon-btn-copy {
            background: #6b7280;
            color: white;
        }

        .icon-btn-copy:hover {
            background: #4b5563;
        }

        .icon-btn-delete {
            background: #ef4444;
            color: white;
        }

        .icon-btn-delete:hover {
            background: #dc2626;
        }

        .history-empty {
            text-align: center;
            color: #9ca3af;
            padding: 30px;
            font-style: italic;
        }

        .clear-history-btn {
            margin-top: 15px;
            width: 100%;
            padding: 10px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .clear-history-btn:hover {
            background: #dc2626;
        }

        .quick-phrases-container {
            background: #f0fdf4;
            border: 2px solid #86efac;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .quick-phrase-item {
            background: white;
            padding: 10px 12px;
            margin-bottom: 6px;
            border-radius: 8px;
            border-left: 4px solid #22c55e;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .quick-phrase-item:hover {
            background: #f0fdf4;
        }

        .quick-phrase-item:last-child {
            margin-bottom: 0;
        }

        .quick-phrase-text {
            color: #1f2937;
            font-weight: 500;
            flex: 1;
        }

        .quick-phrase-actions {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
        }

        .quick-icon-btn {
            padding: 6px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            touch-action: manipulation;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
        }

        .quick-icon-btn svg {
            width: 18px;
            height: 18px;
        }

        .quick-icon-btn-use {
            background: #22c55e;
            color: white;
        }

        .quick-icon-btn-use:hover {
            background: #16a34a;
        }

        .quick-icon-btn-read {
            background: #3b82f6;
            color: white;
        }

        .quick-icon-btn-read:hover {
            background: #2563eb;
        }

        .quick-icon-btn-delete {
            background: #ef4444;
            color: white;
        }

        .quick-icon-btn-delete:hover {
            background: #dc2626;
        }

        .add-quick-phrase-btn {
            width: 100%;
            padding: 10px;
            background: #22c55e;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .add-quick-phrase-btn:hover {
            background: #16a34a;
        }

        @media (max-width: 600px) {
            .container {
                padding: 25px;
            }

            h1 {
                font-size: 1.5em;
            }

            textarea {
                font-size: 17px;
                padding: 15px;
            }

            select {
                font-size: 17px;
                padding: 16px 50px 16px 15px;
                min-height: 56px;
            }

            option, optgroup {
                font-size: 16px;
            }

            button {
                min-width: 100%;
                font-size: 18px;
                padding: 18px 20px;
                min-height: 60px;
            }

            .buttons {
                gap: 12px;
            }

            .quick-phrase-item {
                flex-direction: column;
                align-items: flex-start;
            }

            .quick-phrase-actions {
                width: 100%;
                justify-content: flex-end;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Assistant Parole</h1>
        
        <div class="input-group">
            <label for="textInput">Écrivez votre texte ici :</label>
            <textarea 
                id="textInput" 
                placeholder="Tapez le texte que vous voulez entendre..."
                aria-label="Zone de texte pour la synthèse vocale"
            >Bonjour ! Je suis votre assistant parole. Écrivez quelque chose et je le lirai pour vous.</textarea>
        </div>

        <div class="controls">
            <div>
                <label for="voiceSelect">Voix :</label>
                <select id="voiceSelect" aria-label="Sélection de la voix"></select>
            </div>
            <div>
                <label for="rateSelect">Vitesse :</label>
                <select id="rateSelect" aria-label="Sélection de la vitesse">
                    <option value="0.5">Très lent</option>
                    <option value="0.6">Batman (Lent et menaçant)</option>
                    <option value="0.75">Lent</option>
                    <option value="1" selected>Normal</option>
                    <option value="1.25">Rapide</option>
                    <option value="1.5">Très rapide</option>
                </select>
            </div>
            <div>
                <label for="pitchSelect">Hauteur :</label>
                <select id="pitchSelect" aria-label="Sélection de la hauteur de la voix">
                    <option value="0.5">Batman (Ultra grave)</option>
                    <option value="0.6">Très très grave</option>
                    <option value="0.75">Grave</option>
                    <option value="1" selected>Normal</option>
                    <option value="1.25">Aigu</option>
                    <option value="1.5">Très aigu</option>
                    <option value="2">Très très aigu</option>
                </select>
            </div>
        </div>

        <div class="buttons">
            <button class="btn-speak" id="speakBtn" aria-label="Lire le texte">
                Lire
            </button>
            <button class="btn-stop" id="stopBtn" disabled aria-label="Arrêter la lecture">
                Stop
            </button>
            <button class="btn-clear" id="clearBtn" aria-label="Effacer le texte">
                Effacer
            </button>
        </div>

        <div class="status idle" id="status" role="status" aria-live="polite">
            Prêt à lire
        </div>

        <div class="collapsible-section">
            <div class="section-header" onclick="toggleSection('quickPhrases')">
                <h2>Phrases rapides</h2>
                <div class="section-toggle">
                    <span id="quickPhrasesCount"></span>
                    <svg class="toggle-icon" id="quickPhrasesIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                </div>
            </div>
            <div class="section-content" id="quickPhrasesContent">
                <div class="quick-phrases-container" id="quickPhrasesContainer"></div>
                <button class="add-quick-phrase-btn" id="addQuickPhraseBtn">
                    Ajouter la phrase actuelle
                </button>
            </div>
        </div>

        <div class="collapsible-section">
            <div class="section-header" onclick="toggleSection('history')">
                <h2>Historique des phrases</h2>
                <div class="section-toggle">
                    <span id="historyCount"></span>
                    <svg class="toggle-icon" id="historyIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                </div>
            </div>
            <div class="section-content" id="historyContent">
                <div class="history-container" id="historyContainer">
                    <div class="history-empty">
                        Aucune phrase dans l'historique.
                    </div>
                </div>
                <button class="clear-history-btn" id="clearHistoryBtn" style="display: none;">
                    Effacer tout l'historique
                </button>
            </div>
        </div>
    </div>

    <script>
        const textInput = document.getElementById('textInput');
        const voiceSelect = document.getElementById('voiceSelect');
        const rateSelect = document.getElementById('rateSelect');
        const pitchSelect = document.getElementById('pitchSelect');
        const speakBtn = document.getElementById('speakBtn');
        const stopBtn = document.getElementById('stopBtn');
        const clearBtn = document.getElementById('clearBtn');
        const status = document.getElementById('status');
        const historyContainer = document.getElementById('historyContainer');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');
        const quickPhrasesContainer = document.getElementById('quickPhrasesContainer');
        const addQuickPhraseBtn = document.getElementById('addQuickPhraseBtn');

        let voices = [];
        let synthesis = window.speechSynthesis;
        let history = [];
        let quickPhrases = [];

        const defaultQuickPhrases = [
            "Oui",
            "Non",
            "S'il vous plaît",
            "D'accord",
            "Pas d'accord",
            "Laissez-moi le temps d'écrire ce que je dois dire",
            "Soyez patient, je parle avec un assistant parole",
            "Merci de me laisser la parole",
            "Vous faites preuve d'inclusion en me laissant parler",
            "Ne raccrochez pas ! Je ne suis pas une IA, je parle avec une machine",
            "Ne soyez pas validiste !"
        ];

        function toggleSection(sectionName) {
            const content = document.getElementById(sectionName + 'Content');
            const icon = document.getElementById(sectionName + 'Icon');
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                icon.classList.remove('collapsed');
            } else {
                content.classList.add('collapsed');
                icon.classList.add('collapsed');
            }
        }

        function updateSectionCounts() {
            document.getElementById('quickPhrasesCount').textContent = quickPhrases.length + ' phrase' + (quickPhrases.length > 1 ? 's' : '');
            document.getElementById('historyCount').textContent = history.length + ' phrase' + (history.length > 1 ? 's' : '');
        }

        function loadVoices() {
            voices = synthesis.getVoices();
            
            if (voices.length === 0) {
                return;
            }
            
            voiceSelect.innerHTML = '';
            
            const frenchVoices = voices.filter(function(v) { return v.lang && v.lang.startsWith('fr'); });
            const maleVoices = frenchVoices.filter(function(v) {
                const name = v.name.toLowerCase();
                return name.includes('male') || name.includes('homme') || name.includes('thomas') || name.includes('daniel') || name.includes('paul') || name.includes('henri');
            });
            const femaleVoices = frenchVoices.filter(function(v) {
                const name = v.name.toLowerCase();
                return name.includes('female') || name.includes('femme') || name.includes('amélie') || name.includes('marie') || name.includes('céline');
            });
            const otherFrenchVoices = frenchVoices.filter(function(v) {
                return maleVoices.indexOf(v) === -1 && femaleVoices.indexOf(v) === -1;
            });
            const nonFrenchVoices = voices.filter(function(v) { return !v.lang || !v.lang.startsWith('fr'); });
            
            if (femaleVoices.length > 0) {
                const femaleGroup = document.createElement('optgroup');
                femaleGroup.label = 'Voix féminines françaises';
                femaleVoices.forEach(function(voice) {
                    const option = document.createElement('option');
                    option.value = voices.indexOf(voice);
                    option.textContent = voice.name;
                    femaleGroup.appendChild(option);
                });
                voiceSelect.appendChild(femaleGroup);
            }
            
            if (maleVoices.length > 0) {
                const maleGroup = document.createElement('optgroup');
                maleGroup.label = 'Voix masculines françaises';
                maleVoices.forEach(function(voice) {
                    const option = document.createElement('option');
                    option.value = voices.indexOf(voice);
                    option.textContent = voice.name;
                    maleGroup.appendChild(option);
                });
                voiceSelect.appendChild(maleGroup);
            }
            
            if (otherFrenchVoices.length > 0) {
                const otherFrGroup = document.createElement('optgroup');
                otherFrGroup.label = 'Autres voix françaises';
                otherFrenchVoices.forEach(function(voice) {
                    const option = document.createElement('option');
                    option.value = voices.indexOf(voice);
                    option.textContent = voice.name;
                    if (voice.default) option.selected = true;
                    otherFrGroup.appendChild(option);
                });
                voiceSelect.appendChild(otherFrGroup);
            }
            
            if (nonFrenchVoices.length > 0) {
                const otherGroup = document.createElement('optgroup');
                otherGroup.label = 'Autres langues';
                nonFrenchVoices.forEach(function(voice) {
                    const option = document.createElement('option');
                    option.value = voices.indexOf(voice);
                    option.textContent = voice.name + ' (' + voice.lang + ')';
                    otherGroup.appendChild(option);
                });
                voiceSelect.appendChild(otherGroup);
            }
        }

        loadVoices();
        if (synthesis.onvoiceschanged !== undefined) {
            synthesis.onvoiceschanged = loadVoices;
        }
        setTimeout(loadVoices, 100);
        setTimeout(loadVoices, 500);
        setTimeout(loadVoices, 1000);

        function loadQuickPhrases() {
            const storedData = {};
            for (let i = 0; i < 100; i++) {
                const key = 'quickPhrase_' + i;
                const value = localStorage.getItem(key);
                if (value) {
                    storedData[key] = value;
                }
            }
            
            if (Object.keys(storedData).length > 0) {
                quickPhrases = Object.values(storedData);
            } else {
                quickPhrases = defaultQuickPhrases.slice();
                saveQuickPhrases();
            }
            
            renderQuickPhrases();
            updateSectionCounts();
        }

        function saveQuickPhrases() {
            for (let i = 0; i < 100; i++) {
                localStorage.removeItem('quickPhrase_' + i);
            }
            quickPhrases.forEach(function(phrase, index) {
                localStorage.setItem('quickPhrase_' + index, phrase);
            });
        }

        function renderQuickPhrases() {
            if (quickPhrases.length === 0) {
                quickPhrasesContainer.innerHTML = '<div class="history-empty">Aucune phrase rapide.</div>';
                updateSectionCounts();
                return;
            }

            let html = '';
            quickPhrases.forEach(function(phrase, index) {
                const escapedText = phrase.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
                html += '<div class="quick-phrase-item">';
                html += '<div class="quick-phrase-text">' + escapedText + '</div>';
                html += '<div class="quick-phrase-actions">';
                html += '<button class="quick-icon-btn quick-icon-btn-use" onclick="useQuickPhrase(' + index + ')" title="Utiliser">';
                html += '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>';
                html += '</button>';
                html += '<button class="quick-icon-btn quick-icon-btn-read" onclick="readQuickPhrase(' + index + ')" title="Lire">';
                html += '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>';
                html += '</button>';
                html += '<button class="quick-icon-btn quick-icon-btn-delete" onclick="deleteQuickPhrase(' + index + ')" title="Supprimer">';
                html += '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>';
                html += '</button>';
                html += '</div>';
                html += '</div>';
            });
            
            quickPhrasesContainer.innerHTML = html;
            updateSectionCounts();
        }

        function useQuickPhrase(index) {
            const phrase = quickPhrases[index];
            if (phrase) {
                textInput.value = phrase;
                textInput.focus();
            }
        }

        function readQuickPhrase(index) {
            const phrase = quickPhrases[index];
            if (phrase) {
                textInput.value = phrase;
                speak();
            }
        }

        function deleteQuickPhrase(index) {
            if (confirm('Supprimer cette phrase rapide ?')) {
                quickPhrases.splice(index, 1);
                saveQuickPhrases();
                renderQuickPhrases();
            }
        }

        function addQuickPhrase() {
            const text = textInput.value.trim();
            if (!text) {
                alert('Veuillez entrer du texte.');
                return;
            }
            
            if (quickPhrases.indexOf(text) !== -1) {
                alert('Cette phrase existe déjà.');
                return;
            }
            
            quickPhrases.push(text);
            saveQuickPhrases();
            renderQuickPhrases();
            
            const originalText = addQuickPhraseBtn.textContent;
            addQuickPhraseBtn.textContent = '✓ Ajoutée !';
            setTimeout(function() {
                addQuickPhraseBtn.textContent = originalText;
            }, 2000);
        }

        loadQuickPhrases();
function speak() {
            const text = textInput.value.trim();
            
            if (!text) {
                alert('Veuillez entrer du texte à lire.');
                return;
            }

            addToHistory(text);
            synthesis.cancel();
            
            setTimeout(function() {
                speakText(text);
            }, 100);
        }

        function speakText(text) {
            const utterance = new SpeechSynthesisUtterance(text);
            
            if (voices.length === 0) {
                voices = synthesis.getVoices();
            }
            
            const selectedVoice = voices[voiceSelect.value];
            if (selectedVoice) {
                utterance.voice = selectedVoice;
            }
            
            let pitchValue = parseFloat(pitchSelect.value);
            utterance.pitch = pitchValue;
            utterance.rate = parseFloat(rateSelect.value);
            utterance.volume = 1;
            utterance.lang = selectedVoice ? selectedVoice.lang : 'fr-FR';
            
            utterance.onstart = function() {
                status.textContent = 'Lecture en cours...';
                status.className = 'status speaking';
                speakBtn.disabled = true;
                stopBtn.disabled = false;
            };
            
            utterance.onend = function() {
                status.textContent = 'Lecture terminée';
                status.className = 'status idle';
                speakBtn.disabled = false;
                stopBtn.disabled = true;
            };
            
            utterance.onerror = function(e) {
                let errorMsg = 'Erreur de lecture';
                if (e.error === 'canceled') errorMsg = 'Lecture annulée';
                else if (e.error === 'interrupted') errorMsg = 'Lecture interrompue';
                
                status.textContent = errorMsg;
                status.className = 'status idle';
                speakBtn.disabled = false;
                stopBtn.disabled = true;
            };

            try {
                synthesis.speak(utterance);
            } catch (err) {
                alert('Erreur de lecture.');
            }
        }

        function stop() {
            synthesis.cancel();
            status.textContent = 'Lecture arrêtée';
            status.className = 'status idle';
            speakBtn.disabled = false;
            stopBtn.disabled = true;
        }

        function clear() {
            textInput.value = '';
            textInput.focus();
        }

        function addToHistory(text) {
            const item = {
                id: Date.now(),
                text: text
            };
            
            history.unshift(item);
            renderHistory();
        }

        function renderHistory() {
            if (history.length === 0) {
                historyContainer.innerHTML = '<div class="history-empty">Aucune phrase dans l\'historique.</div>';
                clearHistoryBtn.style.display = 'none';
                updateSectionCounts();
                return;
            }

            clearHistoryBtn.style.display = 'block';
            
            let html = '';
            history.forEach(function(item) {
                const escapedText = item.text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
                html += '<div class="history-item">';
                html += '<div class="history-text">' + escapedText + '</div>';
                html += '<div class="history-actions">';
                html += '<button class="icon-btn icon-btn-play" onclick="playHistory(' + item.id + ')">';
                html += '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>';
                html += 'Relire';
                html += '</button>';
                html += '<button class="icon-btn icon-btn-copy" onclick="copyHistory(' + item.id + ')">';
                html += '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>';
                html += 'Copier';
                html += '</button>';
                html += '<button class="icon-btn icon-btn-delete" onclick="deleteHistory(' + item.id + ')">';
                html += '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>';
                html += 'Supprimer';
                html += '</button>';
                html += '</div>';
                html += '</div>';
            });
            
            historyContainer.innerHTML = html;
            updateSectionCounts();
        }

        function playHistory(id) {
            const item = history.find(function(h) { return h.id === id; });
            if (item) {
                synthesis.cancel();
                setTimeout(function() {
                    speakText(item.text);
                }, 100);
            }
        }

        function copyHistory(id) {
            const item = history.find(function(h) { return h.id === id; });
            if (item) {
                navigator.clipboard.writeText(item.text).then(function() {
                    alert('Texte copié !');
                }).catch(function() {
                    alert('Erreur lors de la copie');
                });
            }
        }

        function deleteHistory(id) {
            history = history.filter(function(h) { return h.id !== id; });
            renderHistory();
        }

        function clearAllHistory() {
            if (confirm('Effacer tout l\'historique ?')) {
                history = [];
                renderHistory();
            }
        }
speakBtn.addEventListener('click', speak);
        stopBtn.addEventListener('click', stop);
        clearBtn.addEventListener('click', clear);
        addQuickPhraseBtn.addEventListener('click', addQuickPhrase);
        clearHistoryBtn.addEventListener('click', clearAllHistory);

        textInput.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                speak();
            }
        });
    </script>
</body>
</html>

